/**
 * Â© 2022 WavePlay <dev@waveplay.com>
 */
import type { PilotConfig } from '@waveplay/pilot';
import appRoot from 'app-root-path';
import fs from 'fs-extra';
import path from 'path';
import type { Logger } from 'pino';
import { syncManifest } from '../..';
import koder, { Kode } from '../../koder';
import type { BuildManifest, Config } from '../../types';

const GENERATED_FILE = 'config.js';

export const buildConfig = async (logger: Logger) => {
	// Read the config file
	logger.debug(`[PilotJS] Reading config...`);
	const config = (await import(path.join(process.cwd(), 'pilot.config.js')))?.default as Config;
	const nextConfig = (await import(path.join(process.cwd(), 'next.config.js')))?.default;

	// Steal some Next.js config values
	if (!config?.i18n && nextConfig?.i18n) {
		config.i18n = nextConfig.i18n;
	}

	// Prepare to write generated config
	let kode = koder({ comment: 'This file was automatically generated by PilotJS' })
		.const('config', { export: true });

	// Skip this step if no config was found
	if (!Object.keys(config).length) {
		logger.debug(`[PilotJS] No config found`);
		await writeConfig(logger, kode, {});
		return;
	}
	logger.debug(`[PilotJS] Loaded config file`, config);

	// Write usable config
	logger.debug(`[PilotJS] Writing generated config...`);
	await writeConfig(logger, kode, {
		cacheSize: config.cacheSize,
		host: config.host,
		i18n: config.i18n
	});
};

const writeConfig = async (logger: Logger, kode: Kode, value: PilotConfig) => {
	// Write the generated config file
	const file = appRoot + '/node_modules/@waveplay/pilot/dist/_generated/' + GENERATED_FILE;
	await fs.outputFile(file, kode.value(value).toString());
	
	// Apply newly read pages to the manifest
	await syncManifest((manifest: BuildManifest) => {
		manifest.config = value;
	}, logger);
};
